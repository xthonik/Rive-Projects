<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kolesa Plus Onboarding - All Artboards</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: rgb(26, 123, 235);
      position: relative;
    }
    .swiper {
      width: 375px;
      height: 340px;
    }
    .rive-canvas {
      width: 375px;
      height: 320px;
      background-color: transparent;
    }
    .artboard-label {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 10;
    }
    .language-selector {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .language-selector label {
      font-family: Arial, sans-serif;
      font-size: 14px;
      margin-right: 8px;
      color: #333;
    }
    .language-selector select {
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="language-selector">
    <label for="language-select">Язык:</label>
    <select id="language-select">
      <option value="ru">Русский</option>
      <option value="kz">Қазақша</option>
    </select>
  </div>

  <div class="swiper">
    <div class="swiper-wrapper">
      <div class="swiper-slide">
        <div class="artboard-label" id="label1">Loading...</div>
        <canvas id="canvas1" class="rive-canvas"></canvas>
      </div>
      <div class="swiper-slide">
        <div class="artboard-label" id="label2">Loading...</div>
        <canvas id="canvas2" class="rive-canvas"></canvas>
      </div>
      <div class="swiper-slide">
        <div class="artboard-label" id="label3">Loading...</div>
        <canvas id="canvas3" class="rive-canvas"></canvas>
      </div>
    </div>
    <div class="swiper-pagination" style="position: fixed; bottom: 20px;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="https://unpkg.com/@rive-app/webgl2@latest"></script>
  <script>
    let r1, r2, r3;
    let viewModels = {}; // Для хранения view model инстансов каждого артборда

    const initRive = () => {
      // Диагностика: проверяем доступные артборды
      const diagnosticCanvas = document.createElement('canvas');
      diagnosticCanvas.width = 1;
      diagnosticCanvas.height = 1;

      const diagnosticRive = new rive.Rive({
        src: "plus_onboarding_prod.riv",
        canvas: diagnosticCanvas,
        onLoad: () => {
          console.log('=== DIAGNOSTIC INFO ===');
          console.log('Available artboards:', diagnosticRive.contents?.artboards || 'Not available');
          console.log('Available animations:', diagnosticRive.animationNames || 'Not available');
          console.log('Available state machines:', diagnosticRive.stateMachineNames || 'Not available');
          console.log('Active artboard:', diagnosticRive.activeArtboard?.name || 'Not available');
          console.log('Contents:', diagnosticRive.contents);
          console.log('======================');

          // Определяем правильные названия артбордов
          const allArtboards = diagnosticRive.contents?.artboards || [];
          const stateMachines = diagnosticRive.stateMachineNames || [];

          console.log('=== AVAILABLE ARTBOARDS ===');
          allArtboards.forEach((artboard, idx) => {
            console.log(`${idx}: ${artboard.name}`);
          });
          console.log('=== AVAILABLE STATE MACHINES ===');
          stateMachines.forEach((sm, idx) => {
            console.log(`${idx}: ${sm}`);
          });

          // Создаем маппинг: canvas index -> artboard name
          const artboardMapping = [
            { canvas: 'canvas1', artboard: 'price_history', stateMachine: 'price_history_sm' },
            { canvas: 'canvas2', artboard: 'filter', stateMachine: 'filter_sm' },
            { canvas: 'canvas3', artboard: 'subs_to_search', stateMachine: 'subs_to_search_sm' }
          ];

          // Создаем экземпляры Rive для каждого canvas
          artboardMapping.forEach((mapping, index) => {
            const canvas = document.getElementById(mapping.canvas);
            const artboardName = mapping.artboard;
            const stateMachineName = mapping.stateMachine;

            console.log(`Setting up ${mapping.canvas} with artboard: ${artboardName}, state machine: ${stateMachineName}`);

            console.log(`Creating Rive instance for artboard: ${artboardName}, state machine: ${stateMachineName}`);

            const riveInstance = new rive.Rive({
              src: "plus_onboarding_prod.riv",
              canvas: canvas,
              autoplay: true,
              autoBind: true,
              artboard: artboardName,
              stateMachines: stateMachineName,
              layout: new rive.Layout({ fit: rive.Fit.Contain }),
              onLoad: () => {
                riveInstance.resizeDrawingSurfaceToCanvas();
                console.log(`✅ Artboard "${artboardName}" loaded successfully`);

                // Обновляем метку с названием артборда
                const labelElement = document.getElementById(`label${index + 1}`);
                labelElement.textContent = artboardName;

                try {
                  console.log(`=== VIEW MODEL DIAGNOSTICS FOR ${artboardName} ===`);

                  // Проверяем наличие view model instance
                  const vmInstance = riveInstance.viewModelInstance;
                  console.log(`${artboardName} - View model instance exists:`, !!vmInstance);

                  if (vmInstance) {
                    // Получаем все доступные методы и свойства
                    const vmKeys = Object.getOwnPropertyNames(Object.getPrototypeOf(vmInstance));
                    const vmOwnKeys = Object.keys(vmInstance);
                    console.log(`${artboardName} - VM prototype methods:`, vmKeys);
                    console.log(`${artboardName} - VM own properties:`, vmOwnKeys);

                    // Проверяем наличие метода viewModel
                    console.log(`${artboardName} - Has viewModel method:`, typeof vmInstance.viewModel === 'function');

                    // Пытаемся получить именованные view models
                    if (typeof vmInstance.viewModel === 'function') {
                      // Проверяем все доступные view models в файле
                      console.log(`${artboardName} - Checking all available view models...`);

                      // Пробуем получить список всех view models
                      try {
                        const availableVMs = vmInstance._viewModelInstances || {};
                        console.log(`${artboardName} - Available view model instances:`, Object.keys(availableVMs));

                        // Проверяем каждый доступный view model
                        Object.keys(availableVMs).forEach(vmName => {
                          console.log(`${artboardName} - Checking view model: ${vmName}`);
                          try {
                            const vm = vmInstance.viewModel(vmName);
                            if (vm) {
                              console.log(`${artboardName} - View model '${vmName}' properties:`, Object.keys(vm));

                              // Проверяем наличие enum метода
                              if (typeof vm.enum === 'function') {
                                try {
                                  const languageEnum = vm.enum('language');
                                  if (languageEnum) {
                                    console.log(`${artboardName} - Found language enum in '${vmName}':`, languageEnum.value);
                                    viewModels[artboardName] = { viewModel: vm, languageEnum, vmName };

                                    const currentLanguage = document.getElementById('language-select').value;
                                    languageEnum.value = currentLanguage;
                                    console.log(`${artboardName} - Initial language set to:`, languageEnum.value);
                                    return; // Выходим после первого найденного enum
                                  }
                                } catch (e) {
                                  console.log(`${artboardName} - No language enum in '${vmName}'`);
                                }
                              }
                            }
                          } catch (e) {
                            console.log(`${artboardName} - Error accessing view model '${vmName}':`, e.message);
                          }
                        });
                      } catch (e) {
                        console.log(`${artboardName} - Error getting view model list:`, e.message);
                      }

                      // Если не нашли view model, пробуем использовать properties напрямую
                      if (!viewModels[artboardName]) {
                        console.log(`${artboardName} - Trying direct properties access...`);

                        try {
                          // Проверяем наличие enum напрямую
                          const languageEnum = vmInstance.enum('language');
                          if (languageEnum) {
                            console.log(`${artboardName} - Found language enum in root VM:`, languageEnum.value);
                            viewModels[artboardName] = { viewModel: vmInstance, languageEnum, vmName: 'root' };

                            const currentLanguage = document.getElementById('language-select').value;
                            languageEnum.value = currentLanguage;
                            console.log(`${artboardName} - Initial language set to:`, languageEnum.value);
                          } else {
                            console.warn(`${artboardName} - No language enum found anywhere`);
                          }
                        } catch (e) {
                          console.warn(`${artboardName} - Error accessing root enum:`, e.message);
                        }
                      }
                    }

                    // Также проверим state machines как альтернативу
                    console.log(`${artboardName} - Available state machines:`, riveInstance.stateMachineNames);

                    // Проверим inputs в state machines
                    riveInstance.stateMachineNames?.forEach(smName => {
                      try {
                        const inputs = riveInstance.stateMachineInputs(smName);
                        console.log(`${artboardName} - State machine '${smName}' inputs:`, inputs?.map(input => ({
                          name: input.name,
                          type: input.type,
                          value: input.value
                        })));

                        // Ищем input с именем, похожим на language
                        const languageInput = inputs?.find(input =>
                          input.name.toLowerCase().includes('lang') ||
                          input.name.toLowerCase().includes('language') ||
                          input.name.toLowerCase().includes('locale')
                        );

                        if (languageInput) {
                          console.log(`${artboardName} - Found language-like input in '${smName}':`, languageInput);
                          viewModels[artboardName] = {
                            viewModel: null,
                            languageEnum: null,
                            stateMachineInput: languageInput,
                            stateMachineName: smName,
                            inputType: 'stateMachine'
                          };

                          // Пробуем установить значение
                          try {
                            const currentLanguage = document.getElementById('language-select').value;
                            if (languageInput.type === 0) { // Number
                              languageInput.value = currentLanguage === 'ru' ? 0 : 1;
                            } else if (languageInput.type === 1) { // Boolean
                              languageInput.value = currentLanguage === 'ru';
                            }
                            console.log(`${artboardName} - State machine language input set to:`, languageInput.value);
                          } catch (e) {
                            console.error(`${artboardName} - Error setting state machine input:`, e);
                          }
                        }
                      } catch (e) {
                        console.error(`${artboardName} - Error accessing state machine '${smName}':`, e);
                      }
                    });

                  } else {
                    console.warn(`${artboardName} - No view model instance available`);
                  }

                  console.log(`=== END DIAGNOSTICS FOR ${artboardName} ===`);
                } catch (error) {
                  console.error(`${artboardName} - View model diagnostics error:`, error);
                }

                // Сохраняем ссылку на экземпляр
                if (index === 0) r1 = riveInstance;
                else if (index === 1) r2 = riveInstance;
                else if (index === 2) r3 = riveInstance;
              },
              onLoadError: (error) => {
                console.error(`❌ Failed to load artboard "${artboardName}":`, error);

                // Попробуем загрузить без указания артборда
                const fallbackInstance = new rive.Rive({
                  src: "plus_onboarding_prod.riv",
                  canvas: canvas,
                  autoplay: true,
                  layout: new rive.Layout({ fit: rive.Fit.Contain }),
                  onLoad: () => {
                    console.log(`✅ Fallback: Default artboard loaded for ${canvasId}`);
                    fallbackInstance.resizeDrawingSurfaceToCanvas();

                    if (index === 0) r1 = fallbackInstance;
                    else if (index === 1) r2 = fallbackInstance;
                    else if (index === 2) r3 = fallbackInstance;
                  },
                  onLoadError: (fallbackError) => {
                    console.error(`❌ Fallback failed for ${canvasId}:`, fallbackError);
                    // Добавим текст ошибки на canvas
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'red';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Error loading ${artboardName}`, canvas.width / 2, canvas.height / 2);
                  }
                });
              }
            });
          });
        },
        onLoadError: (error) => {
          console.error('❌ Diagnostic failed:', error);
        }
      });

    };

    const swiper = new Swiper('.swiper', {
      direction: 'horizontal',
      loop: false,
      pagination: {
        el: '.swiper-pagination',
        clickable: true
      },
      on: {
        slideChange: function () {
          console.log('Slide changed to:', this.activeIndex);
          // Перезапуск анимации при переключении слайда
          const activeRive = [r1, r2, r3][this.activeIndex];
          if (activeRive && activeRive.play) {
            activeRive.play();
          }
        },
      },
    });

    window.addEventListener("load", initRive);

    window.addEventListener('resize', () => {
      if (r1) r1.resizeDrawingSurfaceToCanvas();
      if (r2) r2.resizeDrawingSurfaceToCanvas();
      if (r3) r3.resizeDrawingSurfaceToCanvas();
    });

    // Обработчик изменения языка
    function changeLanguage(newLanguage) {
      console.log('=== CHANGING LANGUAGE TO:', newLanguage, '===');
      console.log('Available view models:', Object.keys(viewModels));

      let successCount = 0;
      let errorCount = 0;

      Object.keys(viewModels).forEach(artboardName => {
        const vmData = viewModels[artboardName];
        console.log(`${artboardName} - View model data:`, vmData);

        try {
          if (vmData.inputType === 'stateMachine' && vmData.stateMachineInput) {
            // Работаем с state machine input
            const input = vmData.stateMachineInput;
            const oldValue = input.value;

            if (input.type === 0) { // Number
              input.value = newLanguage === 'ru' ? 0 : 1;
            } else if (input.type === 1) { // Boolean
              input.value = newLanguage === 'ru';
            } else {
              // Для других типов пробуем установить как строку
              input.value = newLanguage;
            }

            const newValue = input.value;
            console.log(`${artboardName} - State machine input changed: ${oldValue} → ${newValue}`);

            if (newValue !== oldValue) {
              successCount++;
              console.log(`✅ ${artboardName} - State machine language change successful`);
            } else {
              errorCount++;
              console.warn(`⚠️ ${artboardName} - State machine input value didn't change`);
            }

          } else if (vmData && vmData.languageEnum) {
            // Работаем с view model enum
            const oldValue = vmData.languageEnum.value;
            vmData.languageEnum.value = newLanguage;
            const newValue = vmData.languageEnum.value;

            console.log(`${artboardName} - View model enum changed: ${oldValue} → ${newValue}`);

            if (newValue === newLanguage) {
              successCount++;
              console.log(`✅ ${artboardName} - View model language change successful`);
            } else {
              errorCount++;
              console.error(`❌ ${artboardName} - View model language change failed: expected ${newLanguage}, got ${newValue}`);
            }
          } else {
            errorCount++;
            console.warn(`${artboardName} - No language control available for change`);
          }
        } catch (error) {
          errorCount++;
          console.error(`${artboardName} - Failed to change language:`, error);
        }
      });

      console.log(`Language change summary: ${successCount} successful, ${errorCount} errors`);
      console.log('=== LANGUAGE CHANGE COMPLETE ===');
    }

    // Диагностическая функция для отображения всех view models
    function showAllViewModels() {
      console.log('=== COMPLETE VIEW MODEL DIAGNOSTICS ===');
      console.log('Total view models found:', Object.keys(viewModels).length);
      console.log('View models details:', viewModels);

      Object.keys(viewModels).forEach(artboardName => {
        const vmData = viewModels[artboardName];
        console.log(`\n--- ${artboardName} ---`);
        console.log('Control type:', vmData?.inputType || 'viewModel');
        console.log('View model name:', vmData?.vmName || 'unknown');
        console.log('View model exists:', !!vmData?.viewModel);
        console.log('Language enum exists:', !!vmData?.languageEnum);
        console.log('State machine input exists:', !!vmData?.stateMachineInput);

        if (vmData?.inputType === 'stateMachine' && vmData?.stateMachineInput) {
          const input = vmData.stateMachineInput;
          console.log('State machine name:', vmData.stateMachineName);
          console.log('Input name:', input.name);
          console.log('Input type:', input.type);
          console.log('Current input value:', input.value);

          // Проверяем, можем ли мы изменить значение
          try {
            const oldValue = input.value;
            if (input.type === 0) { // Number
              input.value = input.value === 0 ? 1 : 0;
            } else if (input.type === 1) { // Boolean
              input.value = !input.value;
            }
            console.log('State machine test change:', oldValue, '→', input.value);
            // Возвращаем обратно
            input.value = oldValue;
          } catch (e) {
            console.error('State machine test change failed:', e.message);
          }
        }

        if (vmData?.languageEnum && vmData?.inputType !== 'stateMachine') {
          console.log('Current language value:', vmData.languageEnum.value);
          console.log('Language enum type:', typeof vmData.languageEnum);

          // Проверяем, можем ли мы изменить значение
          try {
            const testValue = vmData.languageEnum.value === 'ru' ? 'kz' : 'ru';
            vmData.languageEnum.value = testValue;
            console.log('View model test change successful:', vmData.languageEnum.value);
            // Возвращаем обратно
            vmData.languageEnum.value = vmData.languageEnum.value === 'ru' ? 'kz' : 'ru';
          } catch (e) {
            console.error('View model test change failed:', e.message);
          }
        }

        if (vmData?.viewModel) {
          console.log('View model properties:', Object.keys(vmData.viewModel));
          console.log('View model methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(vmData.viewModel)));
        }
      });

      console.log('=== END COMPLETE DIAGNOSTICS ===');
    }

    // Добавляем обработчик события на селектор языка
    document.getElementById('language-select').addEventListener('change', (event) => {
      const selectedLanguage = event.target.value;
      changeLanguage(selectedLanguage);
    });

    // Показываем все view models через 3 секунды после загрузки
    setTimeout(() => {
      showAllViewModels();
    }, 3000);

    console.log('Language selector initialized. Available view models:', Object.keys(viewModels));
  </script>
</body>
</html>
